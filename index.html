<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ਪੰਜਾਬ ਜ਼ਮੀਨ ਮਾਪ (Punjab Land Measure)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body, button, input, select, textarea { 
            font-family: 'Noto Sans Gurmukhi', sans-serif; 
        }

        body { 
            background-color: #e0e0e0; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
        }

        .main-container {
            width: 100%;
            max-width: 1350px;
            height: 100vh;
            background: white;
            box-shadow: none;
            border-radius: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* === TAB BAR === */
        .tab-bar {
            display: flex;
            background: #263238;
            flex-shrink: 0;
            height: 50px; 
            align-items: center;
            padding-right: 15px; 
            justify-content: flex-end; 
            gap: 10px;
        }
        
        .search-wrapper {
            display: flex; gap: 5px; align-items: center; margin-right: 10px; 
            border-right: 1px solid rgba(255,255,255,0.2); padding-right: 15px;
        }

        .round-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(38, 50, 56, 0.85); color: #fff;
            font-size: 14px; cursor: pointer; display: flex;
            justify-content: center; align-items: center;
            transition: all 0.2s ease;
        }

        .round-btn:hover { background: rgba(38, 50, 56, 1); transform: scale(1.1); }
        .round-btn.active { background: #03a9f4; color: white; border-color: #03a9f4; box-shadow: 0 0 10px #03a9f4; }
        
        .btn-search { background: #0288d1; }
        .btn-measure.active { background: rgba(244, 67, 54, 0.9) !important; color: white; border-color: red;}
        .btn-print { background: #d32f2f; border-color: #ffcdd2; } 
        
        .action-row { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-calc-action { background: #e91e63; width: 50px; height: 50px; font-size: 20px; display: flex; }
        .btn-clear-form { background: #ff5722; width: 50px; height: 50px; font-size: 20px; display: flex; border-color: #ffccbc;}

        .tab-content { flex: 1; display: none; height: 100%; position: relative; overflow: hidden; }
        .tab-content.active { display: block; }

        /* === MAP & UI === */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .top-controls-bar {
            position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 8px; z-index: 2000;
        }
        #topBarResult {
            background: rgba(38, 50, 56, 0.9); padding: 8px 16px; border-radius: 20px;
            font-size: 13px; color: #00e5ff; font-weight: bold; border: 1px solid rgba(255,255,255,0.4);
            min-width: 80px; text-align: center;
        }
        input[type="text"] { 
            padding: 6px 10px; border: 1px solid rgba(255,255,255,0.4); border-radius: 20px; width: 140px; 
            font-size: 13px; background: rgba(38, 50, 56, 0.5); color: white; outline: none; text-align: center;
        }
        .map-controls { 
            position: absolute; top: 60px; right: 10px; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; z-index: 1350;
        }
        .map-controls.hidden { display: none !important; }
        #modeLabel {
            font-size: 11px; color: #fff; text-shadow: 0px 0px 3px black; font-weight: bold;
            background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px;
        }

        /* === CALCULATOR FORMS === */
        .calc-wrapper { 
            padding: 10px; 
            background: white; 
            border-radius: 8px; 
            margin: 8px auto; 
            width: 98%; 
            max-width: 750px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .calc-row { 
            display: flex; gap: 4px; align-items: center; margin-bottom: 6px; 
            justify-content: center; flex-wrap: wrap; 
        }
        .calc-row label { 
            width: auto; font-size: 12px; font-weight: bold; color: #37474f; 
            text-align: center; padding: 0; margin-bottom: 2px;
        } 
        .calc-row input { 
            padding: 4px 6px; border: 1px solid #ccc; border-radius: 10px; 
            width: 50px !important; font-size: 12px; height: 28px; text-align: center; 
        }
        select#shapeSelect { 
            padding: 6px 8px; border: 1px solid #ccc; border-radius: 10px; 
            width: 300px !important; font-size: 14px; height: 36px; 
        }

        .area-row-compact { 
            display: flex; gap: 5px; justify-content: center; align-items: flex-end; 
            margin-bottom: 6px; flex-wrap: wrap; 
        }
        .vertical-field { display: flex; flex-direction: column; align-items: center; gap: 1px; }
        .vertical-field span { font-size: 9px; font-weight: bold; color: #006064; }
        .vertical-field input { 
            width: 38px !important; padding: 3px !important; text-align: center; 
            border-radius: 8px !important; border: 1px solid #00acc1 !important;
            font-size: 11px; height: 26px;
        }

        .calc-header { 
            display: flex; justify-content: center; gap: 4px; font-size: 10px; 
            font-weight: bold; color: #555; margin-bottom: 4px; padding-left: 0; 
        }
        .calc-header span { width: 50px; text-align: center; display: block;}

        .section-title { 
            font-size: 16px; color: #37474f; border-bottom: 2px solid #eee; 
            padding-bottom: 6px; margin-bottom: 10px; text-align: center;
        }
        
        .result-box {
            font-size: 15px; color: #4dd0e1; background: #37474f; margin-top: 12px; 
            text-align: center; padding: 10px; border-radius: 8px;
            white-space: pre-line; line-height: 1.3;
        }

        .credit { 
            position: absolute; bottom: 5px; left: 5px; font-size: 10px; 
            color: #555; background: rgba(255,255,255,0.8); padding: 2px 4px; 
            border-radius: 3px; z-index: 9999;
        }
        
        .area-group { 
            background: #e0f7fa; padding: 8px; border-radius: 8px; 
            margin-bottom: 8px; border: 1px solid #b2ebf2; 
        }
        .area-info-bar {
            text-align: center; font-size: 10px; color: #006064; 
            font-weight: bold; margin-top: 6px; padding: 3px; 
            background: rgba(255,255,255,0.5); border-radius: 4px;
        }

        /* === PDF REPORT STYLES === */
        #printReportHeader { display: none; }

        @media print {
            body, html { background: white; height: 100%; overflow: hidden; }
            .main-container { width: 100%; height: 100%; box-shadow: none; display: block; }
            
            /* Hide UI elements */
            .tab-bar, .top-controls-bar, .map-controls, .credit, #tab2, #tab3, #tab4 { 
                display: none !important; 
            }
            
            .tab-content.active { display: block !important; height: 100%; width: 100%; }
            
            /* Show Report Header */
            #printReportHeader {
                display: block !important;
                position: absolute; top: 0; left: 0; width: 100%;
                background: white; text-align: center; z-index: 99999;
                border-bottom: 2px solid #333; padding-bottom: 10px;
                height: 160px; /* Fixed height for header */
            }

            /* Adjust Map for Print */
            #tab1 { position: relative; width: 100%; height: 100%; }
            #map { 
                position: absolute !important;
                top: 170px !important; /* Push map below header */
                height: calc(100% - 175px) !important; 
                width: 100% !important;
                border: 2px solid #333;
                z-index: 0;
            }

            /* Force black text */
            #printReportHeader h2, #printReportHeader h3, #printReportHeader p, #printReportHeader span {
                color: black !important;
                -webkit-print-color-adjust: exact;
            }
        }

        /* MOBILE STYLES */
        @media (max-width: 1080px) {
            .tab-bar { height: 56px; gap: 8px; padding: 0 8px; }
            .search-wrapper input[type="text"] { width: 100px !important; font-size: 12px; }
            .top-controls-bar { top: 58px !important; right: 10px; flex-direction: column; align-items: flex-end; }
            .map-controls { bottom: 10px; top: auto; left: 50%; transform: translateX(-50%); flex-direction: row; background: rgba(38, 50, 56, 0.9); padding: 8px; border-radius: 12px; }
            #modeLabel { font-size: 12px; color: #00e5ff; background: none; }
            select#shapeSelect { width: 160px !important; }
            @media (max-width: 600px) { .search-wrapper { display: none; } }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="tab-bar">
        <div id="mapSearchControls" class="search-wrapper">
            <input type="text" id="searchBox" placeholder="Location...">
            <button class="round-btn btn-search" onclick="searchLocation()"><i class="fas fa-search"></i></button>
        </div>
        <button class="round-btn active" onclick="switchTab('tab1')" title="Map"><i class="fas fa-map"></i></button>
        <button class="round-btn" onclick="switchTab('tab2')" title="Shape Calc"><i class="fas fa-draw-polygon"></i></button>
        <button class="round-btn" onclick="switchTab('tab3')" title="Find 4th Side"><i class="fas fa-vector-square"></i></button>
        <button class="round-btn" onclick="switchTab('tab4')" title="Find 3rd Side"><i class="fas fa-play"></i></button>
    </div>

    <div id="tab1" class="tab-content active"> 
        <div id="printReportHeader">
            <h2 style="margin: 10px 0;">ਪੰਜਾਬ ਜ਼ਮੀਨ ਮਾਪ (Land Measurement Report)</h2>
            <p style="margin: 5px 0;"><strong>Date:</strong> <span id="pdfDate"></span></p>
            <div style="border: 2px solid #000; padding: 5px; margin: 5px 20px; border-radius: 8px; background: #f0f0f0;">
                <h3 style="margin: 5px 0;">Result: <span id="pdfResult" style="color: #d32f2f;"></span></h3>
            </div>
            <p style="font-size: 10px; margin-top:5px;">Generated by Punjab Land Measure App - Raj Kamboj</p>
        </div>

        <div id="map"></div>
        <div class="top-controls-bar">
            <div id="topBarResult">0 ਫੁੱਟ</div>
            <button id="toggleSidebarBtn" class="round-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>
        <div class="map-controls">
            <button id="measureBtn" class="round-btn btn-measure" onclick="toggleMeasuring()"><i class="fas fa-ruler-combined"></i></button>
            <button class="round-btn" onclick="switchMode()"><i class="fas fa-exchange-alt"></i></button>
            <div id="modeLabel">Area(ਖੇਤਰਫਲ)</div>
            <button class="round-btn btn-undo" onclick="undoPoint()"><i class="fas fa-undo"></i></button>
            <button class="round-btn btn-clear" onclick="clearMap()"><i class="fas fa-trash-alt"></i></button>
            <button class="round-btn btn-print" onclick="saveMapAsPDF()" title="Save as PDF"><i class="fas fa-file-pdf"></i></button>
        </div>
    </div>

    <div id="tab2" class="tab-content">
        <div class="calc-wrapper">
            <div class="section-title"><i class="fas fa-draw-polygon"></i> ਆਕਾਰ ਮਾਪ (Shape Measurement)</div>
            <div class="calc-row">
                <label>Shape:</label>
                <select id="shapeSelect" onchange="updateCalcUI()">
                    <option value="rect"> ਵਰਗ/ਆਇਤ (Rectangle)</option>
                    <option value="tri">ਤਿਕੋਣ (Triangle)</option>
                    <option value="rhombus">ਸਮਚਤਰਭੁਜ (Rhombus)</option>
                    <option value="diag">ਚਾਰ ਭੁਜਾਵਾਂ (4 Sides)</option>
                </select>
            </div>
            <div class="calc-header"><span>ਕਰਮ (K)</span><span>ਫੁੱਟ (F)</span><span>ਇੰਚ (I)</span></div>
            <div id="calcInputs"></div>
            
            <div class="action-row">
                <button class="round-btn btn-clear-form" onclick="clearCalcInputs('calcInputs')" title="Clear All"><i class="fas fa-trash"></i></button>
                <button class="round-btn btn-calc-action" onclick="calculateStaticShape()" title="Calculate"><i class="fas fa-check"></i></button>
            </div>

            <div id="staticResult" class="result-box">ਨਤੀਜਾ...</div>
            <canvas id="staticCanvas" width="600" height="300" style="width:100%; border:1px solid #333; margin-top:10px; background:#fffde7; border-radius:8px;"></canvas>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <div class="calc-wrapper">
            <div class="section-title"><i class="fas fa-vector-square"></i> ਚੌਥੀ ਭੁਜਾ ਪਤਾ ਕਰੋ (Find 4th Side)</div>
            <div class="area-group">
                <div style="text-align:center; font-weight:bold; margin-bottom:6px; font-size:12px;">Area (ਖੇਤਰਫਲ)</div>
                <div class="area-row-compact">
                    <div class="vertical-field"><span>ਕਿੱਲਾ</span><input type="number" id="t3_killa" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t3')"></div>
                    <div class="vertical-field"><span>ਕਨਾਲ</span><input type="number" id="t3_kanal" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t3')"></div>
                    <div class="vertical-field"><span>ਮਰਲਾ</span><input type="number" id="t3_marla" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t3')"></div>
                    <div class="vertical-field"><span>ਸਰਸਾਹੀ</span><input type="number" id="t3_sarsahi" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t3')"></div>
                    <div class="vertical-field"><span>Sq.Ft</span><input type="number" id="t3_sqft" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t3')"></div>
                </div>
                <div id="t3_area_preview" class="area-info-bar">Total: 0 Sq Ft | Approx Side (if Square): 0 ft</div>
            </div>
            <div class="calc-header"><span>ਕਰਮ (K)</span><span>ਫੁੱਟ (F)</span><span>ਇੰਚ (I)</span></div>
            <div class="calc-row"><label>Side 1 (Length):</label><input type="number" id="t3_s1_k" value="0"><input type="number" id="t3_s1_f" value="0"><input type="number" id="t3_s1_i" value="0"></div>
            <div class="calc-row"><label>Side 2 (Width 1):</label><input type="number" id="t3_s2_k" value="0"><input type="number" id="t3_s2_f" value="0"><input type="number" id="t3_s2_i" value="0"></div>
            <div class="calc-row"><label>Side 3 (Length 2):</label><input type="number" id="t3_s3_k" value="0"><input type="number" id="t3_s3_f" value="0"><input type="number" id="t3_s3_i" value="0"></div>
            <div class="action-row">
                <button class="round-btn btn-clear-form" onclick="resetForm('t3')"><i class="fas fa-trash"></i></button>
                <button class="round-btn btn-calc-action" onclick="calculateTab3()"><i class="fas fa-check"></i></button>
            </div>
            <div id="t3_result" class="result-box">ਨਤੀਜਾ...</div>
        </div>
    </div>

    <div id="tab4" class="tab-content">
        <div class="calc-wrapper">
            <div class="section-title"><i class="fas fa-play"></i> ਤਿਕੋਣ ਦੀ ਤੀਜੀ ਭੁਜਾ (Find 3rd Side)</div>
            <div class="area-group">
                <div class="area-row-compact">
                    <div class="vertical-field"><span>ਕਿੱਲਾ</span><input type="number" id="t4_killa" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t4')"></div>
                    <div class="vertical-field"><span>ਕਨਾਲ</span><input type="number" id="t4_kanal" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t4')"></div>
                    <div class="vertical-field"><span>ਮਰਲਾ</span><input type="number" id="t4_marla" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t4')"></div>
                    <div class="vertical-field"><span>ਸਰਸਾਹੀ</span><input type="number" id="t4_sarsahi" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t4')"></div>
                    <div class="vertical-field"><span>Sq.Ft</span><input type="number" id="t4_sqft" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)" oninput="updateAreaPreview('t4')"></div>
                </div>
                <div id="t4_area_preview" class="area-info-bar">Total: 0 Sq Ft | Approx Side (if Square): 0 ft</div>
            </div>
            <div class="calc-header"><span>ਕਰਮ (K)</span><span>ਫੁੱਟ (F)</span><span>ਇੰਚ (I)</span></div>
            <div class="calc-row"><label>Side A:</label><input type="number" id="t4_s1_k" value="0"><input type="number" id="t4_s1_f" value="0"><input type="number" id="t4_s1_i" value="0"></div>
            <div class="calc-row"><label>Side B:</label><input type="number" id="t4_s2_k" value="0"><input type="number" id="t4_s2_f" value="0"><input type="number" id="t4_s2_i" value="0"></div>
            <div class="action-row">
                <button class="round-btn btn-clear-form" onclick="resetForm('t4')"><i class="fas fa-trash"></i></button>
                <button class="round-btn btn-calc-action" onclick="calculateTab4()"><i class="fas fa-check"></i></button>
            </div>
            <div id="t4_result" class="result-box">ਨਤੀਜਾ...</div>
        </div>
    </div>

    <div class="credit">Made By : Raj Kamboj 9465428299</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================= SECURITY START =================
var allowedDomain = "yourwebsite.com"; 
(function() {
    var currentHost = window.location.hostname;
    // Note: If testing locally, this security check might block you. 
    // You can temporarily comment out the stopApp() call below to test.
    if (allowedDomain !== "yourwebsite.com" && currentHost.indexOf(allowedDomain) === -1 && currentHost !== "") {
        // stopApp(); // UNCOMMENT THIS TO ENABLE SECURITY
    }
    
    function stopApp() {
        document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#263238;color:#ff5252;font-family:sans-serif;text-align:center;"><h1>ACCESS DENIED</h1></div>';
        throw new Error("Application Stopped");
    }
})();

document.addEventListener('contextmenu', event => event.preventDefault());
document.onkeydown = function(e) {
    if(e.keyCode == 123) return false; 
    if(e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) return false; 
    if(e.ctrlKey && e.keyCode == 85) return false; 
};
// ================= SECURITY END =================

const FEET_PER_KARAM = 5.5;
const INCHES_PER_KARAM = 66;
let map;

function safeFloat(val) { return parseFloat(val) || 0; }
function clearZero(input) { if(input.value == '0') input.value = ''; }
function restoreZero(input) { if(input.value == '') input.value = '0'; }

function inputsToInches(kId, fId, iId) {
    let k = safeFloat(document.getElementById(kId).value);
    let f = safeFloat(document.getElementById(fId).value);
    let i = safeFloat(document.getElementById(iId).value);
    return (k * 66) + (f * 12) + i;
}

function getAreaInSqInches(prefix) {
    let killa = safeFloat(document.getElementById(prefix+'_killa').value);
    let k = safeFloat(document.getElementById(prefix+'_kanal').value);
    let m = safeFloat(document.getElementById(prefix+'_marla').value);
    let s = safeFloat(document.getElementById(prefix+'_sarsahi').value);
    let sqf = safeFloat(document.getElementById(prefix+'_sqft').value);
    return ((killa * 43560) + (k * 5445) + (m * 272.25) + (s * 30.25) + sqf) * 144;
}

function updateAreaPreview(prefix) {
    let totalSqInch = getAreaInSqInches(prefix);
    let totalSqFt = totalSqInch / 144.0;
    let sideFt = Math.sqrt(totalSqFt);
    document.getElementById(prefix + '_area_preview').innerText = `Total: ${totalSqFt.toFixed(2)} Sq Ft | Approx Side (if Square): ${sideFt.toFixed(2)} ft`;
}

function resetForm(prefix) {
    document.querySelectorAll(`input[id^="${prefix}_"]`).forEach(el => el.value = "0");
    updateAreaPreview(prefix);
    document.getElementById(prefix + '_result').innerText = "ਨਤੀਜਾ...";
}

function clearCalcInputs(containerId) {
    document.querySelectorAll(`#${containerId} input`).forEach(el => el.value = "0");
    document.getElementById('staticResult').innerText = "ਨਤੀਜਾ...";
    let cvs = document.getElementById('staticCanvas');
    if (cvs) cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
}

function formatInchesToResult(totalInches) {
    if(totalInches <= 0 || isNaN(totalInches)) return "ਗਲਤ ਮਾਪ (Invalid)";
    let k = Math.floor(totalInches / 66);
    let rem = totalInches % 66;
    let f = Math.floor(rem / 12);
    let i = rem % 12;
    return `${k} ਕਰਮ, ${f} ਫੁੱਟ, ${i.toFixed(2)} ਇੰਚ\nTotal Inches: ${totalInches.toFixed(2)}"`;
}

function convertSqFeetToEnglish(sq_feet) {
    if (sq_feet <= 0) return "0 ਫੁੱਟ";
    let rem = sq_feet;
    let killa = Math.floor(rem / 43560); rem %= 43560;
    let kanal = Math.floor(rem / 5445); rem %= 5445;
    let marla = Math.floor(rem / 272.25); rem %= 272.25;
    let sarsahi = Math.floor(rem / 30.25); rem %= 30.25;
    let feet = rem; 
    let parts = [];
    if (killa) parts.push(killa + " ਕਿੱਲਾ");
    if (kanal) parts.push(kanal + " ਕਨਾਲ");
    if (marla) parts.push(marla + " ਮਰਲਾ");
    if (sarsahi) parts.push(sarsahi + " ਸਰਸਾਹੀ");
    if (feet > 0.01) parts.push(feet.toFixed(2) + " ਫੁੱਟ");
    return parts.length > 0 ? parts.join(", ") : "0 ਫੁੱਟ"; 
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-bar .round-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    let btnIndex = {'tab1':1, 'tab2':2, 'tab3':3, 'tab4':4}[id] || 0;
    document.querySelector(`.tab-bar button:nth-child(${btnIndex + 1})`).classList.add('active');
    const searchControls = document.getElementById('mapSearchControls');
    if(id === 'tab1') {
        searchControls.style.display = 'flex'; 
        if(map) setTimeout(() => map.invalidateSize(), 200);
    } else {
        searchControls.style.display = 'none'; 
    }
}

function toggleSidebar() {
    const sidebar = document.querySelector('.map-controls');
    const toggleBtnIcon = document.querySelector('#toggleSidebarBtn i');
    sidebar.classList.toggle('hidden');
    toggleBtnIcon.classList.toggle('fa-bars');
    toggleBtnIcon.classList.toggle('fa-times');
}

let points = [], markers = [], polyline, polygon;
let measuring = false;
let isAreaMode = true;

function initMap() {
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.9, 75.85], 8);
    L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', { attribution: 'Google', maxZoom: 22 }).addTo(map);
    map.on('click', function(e) { if(measuring) addMapPoint(e.latlng); });
}

function addMapPoint(latlng) {
    points.push(latlng);
    let m = L.marker(latlng, {draggable: true}).addTo(map);
    m.on('drag', function(e) { points[markers.indexOf(m)] = e.latlng; redrawMap(); });
    markers.push(m);
    redrawMap();
}

function redrawMap() {
    if(polyline) map.removeLayer(polyline);
    if(polygon) map.removeLayer(polygon);
    if(points.length > 1) {
        if(isAreaMode && points.length >= 3) polygon = L.polygon(points, {color: 'cyan', weight: 3, fillColor: '#0f0', fillOpacity: 0.4}).addTo(map);
        else polyline = L.polyline(points, {color: 'yellow', weight: 4}).addTo(map);
        calcMapStats();
    }
}

function calcMapStats() {
    let resultText = "0 ਫੁੱਟ";
    if(isAreaMode) {
        if(points.length >= 3) {
            let area = 0; const R = 6378137;
            for (let i = 0; i < points.length; i++) {
                let p1 = points[i], p2 = points[(i + 1) % points.length];
                area += (p2.lng - p1.lng) * (2 + Math.sin(p1.lat * Math.PI / 180) + Math.sin(p2.lat * Math.PI / 180));
            }
            area = Math.abs(area * R * R / 2 * (Math.PI / 180));
            resultText = convertSqFeetToEnglish(area * 10.7639);
        }
    } else {
        let dist = 0;
        for(let i=0; i<points.length-1; i++) dist += points[i].distanceTo(points[i+1]);
        if (dist >= 1000) resultText = "Dist: " + Math.floor(dist / 1000) + " km " + (dist % 1000).toFixed(0) + " m";
        else resultText = "Dist: " + dist.toFixed(2) + " m";
    }
    document.getElementById('topBarResult').innerText = resultText;
}

function toggleMeasuring() {
    measuring = !measuring;
    let btn = document.getElementById('measureBtn');
    if(measuring) {
        clearMapDataOnly();
        btn.innerHTML = '<i class="fas fa-hand-paper"></i>'; btn.classList.add('active');
        document.getElementById('map').style.cursor = "crosshair";
    } else {
        btn.innerHTML = '<i class="fas fa-ruler-combined"></i>'; btn.classList.remove('active');
        document.getElementById('map').style.cursor = "grab";
    }
}

function switchMode() {
    isAreaMode = !isAreaMode;
    document.getElementById('modeLabel').innerText = isAreaMode ? "Area(ਖੇਤਰਫਲ)" : "Distance(ਦੂਰੀ)";
    redrawMap();
    if(points.length) calcMapStats(); else document.getElementById('topBarResult').innerText = "0 ਫੁੱਟ";
}

function undoPoint() { if(points.length > 0) { points.pop(); map.removeLayer(markers.pop()); redrawMap(); } }
function clearMapDataOnly() { points = []; markers.forEach(m => map.removeLayer(m)); markers = []; if(polyline) map.removeLayer(polyline); if(polygon) map.removeLayer(polygon); document.getElementById('topBarResult').innerText = "0 ਫੁੱਟ"; }
function clearMap() { clearMapDataOnly(); measuring = false; document.getElementById('measureBtn').innerHTML = '<i class="fas fa-ruler-combined"></i>'; document.getElementById('measureBtn').classList.remove('active'); document.getElementById('map').style.cursor = "grab"; }

// === NEW: SAVE PDF FUNCTION ===
function saveMapAsPDF() {
    // 1. Get current result
    var currentResult = document.getElementById('topBarResult').innerText;
    // 2. Set result in print header
    document.getElementById('pdfResult').innerText = currentResult;
    // 3. Set date
    var now = new Date();
    document.getElementById('pdfDate').innerText = now.toLocaleString('en-IN'); 
    // 4. Print
    window.print();
}

function searchLocation() { 
    let q = document.getElementById('searchBox').value; 
    if(q) {
        fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q))
            .then(r => r.json()).then(d => { if(d.length > 0) map.setView([d[0].lat, d[0].lon], 16); });
    }
}

const calcRows = {
    'rect': [['len', 'ਲੰਬਾਈ'], ['wid', 'ਚੌੜਾਈ ']],
    'tri': [['s1', 'ਭੁਜਾ A'], ['s2', 'ਭੁਜਾ B'], ['s3', 'ਭੁਜਾ C']],
    'rhombus': [['s1', 'ਭੁਜਾ'], ['s2', 'ਵਿਕਰਣ']],
    'diag': [['s1', 'ਭੁਜਾ AB'], ['s2', 'ਭੁਜਾ BC'], ['s3', 'ਭੁਜਾ CD'], ['s4', 'ਭੁਜਾ DA'], ['diag', 'ਵਿਕਰਣ AC']]
};

function updateCalcUI() {
    let type = document.getElementById('shapeSelect').value;
    let div = document.getElementById('calcInputs');
    div.innerHTML = '';
    calcRows[type].forEach(r => {
        div.innerHTML += `
        <div class="calc-row">
            <label>${r[1]}:</label>
            <input type="number" id="${r[0]}_k" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)">
            <input type="number" id="${r[0]}_f" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)">
            <input type="number" id="${r[0]}_i" value="0" onfocus="clearZero(this)" onblur="restoreZero(this)">
        </div>`;
    });
}

function getValInches(id) { return inputsToInches(id+'_k', id+'_f', id+'_i'); }
function fmtInch(val) { return Math.round(val) + '"'; }

function calculateStaticShape() {
    let type = document.getElementById('shapeSelect').value;
    let areaSqFt = 0; let resultTxt = ""; let drawData = { points: [], lines: [], dashed: [] };
    try {
        if(type === 'rect') {
            let l = getValInches('len'), w = getValInches('wid');
            areaSqFt = (l * w) / 144.0;
            drawData.points = [{x:0,y:0,label:'A'}, {x:l,y:0,label:'B'}, {x:l,y:w,label:'C'}, {x:0,y:w,label:'D'}];
            drawData.lines = [{from:0,to:1,text:fmtInch(l)}, {from:1,to:2,text:fmtInch(w)}, {from:2,to:3,text:fmtInch(l)}, {from:3,to:0,text:fmtInch(w)}];
        } else if(type === 'tri') {
            let a = getValInches('s1'), b = getValInches('s2'), c = getValInches('s3');
            let s = (a+b+c)/2; if(s<=Math.max(a,b,c)) throw "Error";
            areaSqFt = Math.sqrt(s*(s-a)*(s-b)*(s-c)) / 144.0;
            let Ax = (a*a - b*b + c*c)/(2*c), Ay = Math.sqrt(Math.abs(a*a - Ax*Ax));
            drawData.points = [{x:Ax,y:Ay,label:'A'}, {x:c,y:0,label:'B'}, {x:0,y:0,label:'C'}];
            drawData.lines = [{from:2,to:0,text:fmtInch(a)}, {from:0,to:1,text:fmtInch(b)}, {from:1,to:2,text:fmtInch(c)}];
        } else if(type === 'rhombus') {
            let side = getValInches('s1'), diag = getValInches('s2');
            let h1 = diag/2, h2 = Math.sqrt(side*side - h1*h1);
            areaSqFt = (0.5 * diag * (h2*2)) / 144.0;
            drawData.points = [{x:h1,y:0,label:'A'}, {x:diag,y:h2,label:'B'}, {x:h1,y:h2*2,label:'C'}, {x:0,y:h2,label:'D'}];
            drawData.lines = [{from:0,to:1,text:fmtInch(side)},{from:1,to:2,text:fmtInch(side)},{from:2,to:3,text:fmtInch(side)},{from:3,to:0,text:fmtInch(side)}];
            drawData.dashed = [{from:1,to:3,text:fmtInch(diag)}];
        } else if(type === 'diag') {
            let ab=getValInches('s1'), bc=getValInches('s2'), cd=getValInches('s3'), da=getValInches('s4'), ac=getValInches('diag');
            let s1=(ab+bc+ac)/2, s2=(cd+da+ac)/2;
            areaSqFt = (Math.sqrt(s1*(s1-ab)*(s1-bc)*(s1-ac)) + Math.sqrt(s2*(s2-cd)*(s2-da)*(s2-ac))) / 144.0;
        }
        resultTxt = convertSqFeetToEnglish(areaSqFt);
        drawShapeOnCanvas(drawData);
    } catch(e) { resultTxt = "ਗਲਤ ਇਨਪੁਟ (Invalid Input)"; }
    document.getElementById('staticResult').innerText = resultTxt;
}

function drawShapeOnCanvas(data) {
    let cvs = document.getElementById('staticCanvas');
    if (!cvs) return;
    let ctx = cvs.getContext('2d');
    let w = cvs.width, h = cvs.height;
    ctx.clearRect(0,0,w,h); 
    ctx.font="bold 14px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    if(!data.points.length) return;
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    data.points.forEach(p=>{ minX = Math.min(minX, p.x); maxX = Math.max(maxX, p.x); minY = Math.min(minY, p.y); maxY = Math.max(maxY, p.y); });
    let pad=40, sW=maxX-minX||1, sH=maxY-minY||1;
    let scale=Math.min((w-2*pad)/sW, (h-2*pad)/sH);
    function tx(v){return pad+(v-minX)*scale;} 
    function ty(v){return pad+(v-minY)*scale;}
    ctx.strokeStyle="#006064"; ctx.lineWidth=3; ctx.beginPath();
    data.lines.forEach((l,i)=>{ 
        let p1=data.points[l.from]; if(i===0) ctx.moveTo(tx(p1.x),ty(p1.y)); else ctx.lineTo(tx(p1.x),ty(p1.y)); 
    });
    ctx.closePath(); ctx.fillStyle="#e0f7fa"; ctx.fill(); ctx.stroke();
    ctx.fillStyle="#d32f2f";
    data.lines.forEach(l=>{ 
        let p1=data.points[l.from], p2=data.points[l.to];
        let mx=(tx(p1.x)+tx(p2.x))/2, my=(ty(p1.y)+ty(p2.y))/2;
        ctx.fillText(l.text, mx, my);
    });
}

function calculateTab3() {
    let areaSqInch = getAreaInSqInches('t3');
    let l1 = inputsToInches('t3_s1_k', 't3_s1_f', 't3_s1_i');
    let w1 = inputsToInches('t3_s2_k', 't3_s2_f', 't3_s2_i');
    let l2 = inputsToInches('t3_s3_k', 't3_s3_f', 't3_s3_i');
    if(areaSqInch <= 0 || l1 <= 0 || w1 <= 0 || l2 <= 0) {
        document.getElementById('t3_result').innerText = "ਕਿਰਪਾ ਕਰਕੇ ਸਾਰੇ ਵੇਰਵੇ ਭਰੋ (Please fill all fields)"; return;
    }
    let numerator = areaSqInch * 4;
    let denominator = l1 + l2;
    let w2 = (numerator / denominator) - w1;
    document.getElementById('t3_result').innerText = "ਚੌਥੀ ਭੁਜਾ (4th Side):\n" + formatInchesToResult(w2);
}

function calculateTab4() {
    let areaSqInch = getAreaInSqInches('t4');
    let a = inputsToInches('t4_s1_k', 't4_s1_f', 't4_s1_i');
    let b = inputsToInches('t4_s2_k', 't4_s2_f', 't4_s2_i');
    if(areaSqInch <= 0 || a <= 0 || b <= 0) {
        document.getElementById('t4_result').innerText = "ਕਿਰਪਾ ਕਰਕੇ ਸਾਰੇ ਵੇਰਵੇ ਭਰੋ (Please fill all fields)"; return;
    }
    let sinC = (2 * areaSqInch) / (a * b);
    if(sinC > 1) { document.getElementById('t4_result').innerText = "ਇਹ ਸੰਭਵ ਨਹੀਂ ਹੈ (Triangle Impossible)"; return; }
    let angleRad = Math.asin(sinC);
    let cSq = (a*a) + (b*b) - (2*a*b * Math.cos(angleRad));
    let c = Math.sqrt(cSq);
    document.getElementById('t4_result').innerText = "ਤੀਜੀ ਭੁਜਾ (3rd Side):\n" + formatInchesToResult(c);
}

window.onload = function() {
    initMap();
    updateCalcUI();
    switchTab('tab1');
};
</script>
</body>
</html>